version: 1.1.0
preamble: >
          @init_gadfly_plot_env();
          const datadir       =   joinpath("data", "for_paper", "tau-12", "bgk-8");
          const nj            =   64;
          const ni            =   32;
          const nsteps        =   25000;
          const pgrad         =   -1.0e-5;   
          const F             =   [-pgrad, 0.0]; 
          const mu            =   0.2;
          const tauy          =   12.0e-5;
          const forcing_kf    =   init_korner_Fk(F);
col_f: BGK_F(init_constit_srt_bingham_implicit(mu, tauy, 1e8, 1e-12, 15, 1e-6), forcing_kf; feq_f=init_feq_incomp_smoothing(0.90))
datadir: {   value: datadir,       expr: true    }

rho_0:   {   value: 1.0,           expr: false   }
nu:      {   value: mu,            expr: true    }

dx:      {   value: 1.0,           expr: false   }
dt:      {   value: 1.0,           expr: false   }
ni:      {   value:  ni,           expr: true    }
nj:      {   value:  nj,           expr: true    }

simtype:  default
nsteps:   {   value: nsteps,        expr: true   }

bcs:
  - north_bounce_back!
  - south_bounce_back!
  - periodic_east_to_west!

callbacks:
  - print_step_callback(250)
  - write_jld_file_callback(datadir, 2000)
  - write_jld_file_callback(datadir, 5000, true)

finally:
  - write_jld_file_callback(datadir)
  - report_lbm_error(n -> analytical_poise_bingham(mu, tauy, pgrad, n), 1, div(ni, 2), datadir; plot_errors=false)
  - >
    (sim, k) -> begin
      umax = maximum(analytical_poise_bingham(mu, tauy, pgrad, nj));
      umax_approx = maximum(vec(sim.msm.u[1,10,:]));
      info("Re analyt = $(reynolds(umax, nj, mu))");
      info("Bn analyt = $(bingham_number(umax, nj, mu, tauy))");
      info("Re approx = $(reynolds(umax_approx, nj, mu))");
      info("Bn approx = $(bingham_number(umax_approx, nj, mu, tauy))");
    end
  - >
    (sim, k) -> begin
      vpa = vel_prof_acsr(1, div(ni, 2), 1:nj);
      writedlm(joinpath(datadir, "ux_profile.dsv"), 
        begin
          x, y = vpa(sim);
          hcat(x, y);
        end,
        ",");
    end
  - (sim, k) -> plot_lbm_vs_analyt(sim, n -> analytical_poise_bingham(mu, tauy, pgrad, n), 1, div(ni, 2); fname=joinpath(datadir, "lbm-vs-analyt.pdf"));